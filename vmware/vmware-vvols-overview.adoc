---
sidebar: sidebar 
permalink: vmware/vmware-vvols-overview.html 
keywords: tr-4400, vvols, ontap, virtual volumes 
summary: '本节将简要介绍采用ONTAP的VMware vSphere虚拟卷(vvol)' 
---
= 概述
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
二十年来、ONTAP一直是适用于VMware vSphere环境的领先存储解决方案、并不断增加创新功能、以简化管理并降低成本。

本文档介绍了适用于VMware vSphere虚拟卷(vvol)的ONTAP 功能、包括最新的产品信息和用例以及最佳实践和其他可简化部署和减少错误的信息。


NOTE: 本文档将取代先前发布的技术报告_TR-4400：《使用ONTAP的VMware vSphere虚拟卷(Vvol)》_

最佳实践是指南和兼容性列表等其他文档的补充。它们是根据 NetApp 工程师和客户的实验室测试和丰富的现场经验开发的。它们可能不是唯一有效或受支持的实践、但通常是最简单的解决方案、可满足大多数客户的需求。


NOTE: 本文档已进行更新、其中包括vSphere 8.0 Update 3、ONTAP工具10.4版中的新vvol功能以及新的NetApp ASA系统。



== 虚拟卷(Virtual Volume、Virtual Volume、Virtual Volume)概述

NetApp于2012年开始与VMware合作、为适用于vSphere 5的vSphere APIS for Storage AWARMIVAIVAICHUIAICHUDE(VASA )提供支持。通过早期的VASA Provider、可以在配置文件中定义存储功能、这些功能可用于在配置时筛选数据存储库、并在此后检查是否符合策略。随着时间的推移、这种情况不断发展、增加了一些新功能、以便在配置以及添加虚拟卷或vvol (其中、各个存储对象用于虚拟机文件和虚拟磁盘)方面实现更大的自动化。这些对象可以是LUN、文件、现在适用于vSphere 8 - NVMe命名空间(与ONTAP工具9.13P2结合使用)。NetApp与VMware密切合作、作为2015年随vSphere 6发布的vvol的参考合作伙伴、并再次作为在vSphere 8中基于网络结构使用NVMe的vvol的设计合作伙伴。NetApp将继续增强ONTAP 以利用其最新功能。

需要注意以下几个组件：



=== VASA Provider

这是一个软件组件、用于处理VMware vSphere与存储系统之间的通信。对于ONTAP 、VASA Provider在一种称为适用于VMware vSphere的ONTAP 工具(简称ONTAP 工具)的设备中运行。ONTAP 工具还包括一个vCenter插件、一个适用于VMware Site Recovery Manager的存储复制适配器(Storage Replication Adapter、SRA)以及用于构建您自己的自动化的REST API服务器。配置ONTAP 工具并将其注册到vCenter后、几乎不再需要直接与ONTAP 系统交互、因为几乎所有存储需求都可以直接在vCenter UI中进行管理、或者通过REST API自动化进行管理。



=== 协议端点(PE)

协议端点是ESXi主机和VMware数据存储库之间的I/O代理。ONTAP VASA Provider会自动创建这些LUN、可以是VVOL数据存储库的每个FlexVol卷一个协议端点LUN (大小为4 MB)、也可以是托管此数据存储库中的FlexVol卷的存储节点上的每个NFS接口(NFS挂载点、LIF)一个。ESXi主机直接装载这些协议端点、而不是装载单个VVOLLUN和虚拟磁盘文件。协议端点由VASA Provider自动创建、挂载、卸载和删除、因此无需对这些端点进行管理、同时也无需管理任何必要的接口组或导出策略。



=== 虚拟协议端点(VPE)

vSphere 8中的新增功能是、在将基于网络结构的NVMe (NVMe-oF)与vvol结合使用时、协议端点的概念在ONTAP 中不再适用。相反、ESXi主机会在第一个虚拟机启动后自动为每个ANA组建立虚拟PE。ONTAP 会自动为数据存储库使用的每个FlexVol 卷创建ANA组。

使用NVMe-oF for VVOLs的另一个优势是、VASA Provider不需要任何绑定请求。相反、ESXi主机会根据VPE在内部处理VVOl绑定功能。这样可以减少VVOV绑定风暴影响服务的机会。

有关详细信息，请参见 https://docs.vmware.com/en/VMware-vSphere/8.0/vsphere-storage/GUID-23B47AAC-6A31-466C-84F9-8CF8F1CDD149.html["NVMe和虚拟卷"^] 开启 https://docs.vmware.com/en/VMware-vSphere/8.0/vsphere-storage/GUID-23B47AAC-6A31-466C-84F9-8CF8F1CDD149.html["vmware.com"^]



=== 虚拟卷数据存储库

| 虚拟卷数据存储是vVols容器的逻辑数据存储表示，由 VASA 提供商创建和维护。该容器代表由 VASA 提供商管理的存储系统提供的存储容量池。ONTAP工具支持将多个FlexVol卷（称为后备卷）分配给单个vVols数据存储，这些vVols数据存储可以跨越ONTAP集群中的多个节点，将具有不同功能的闪存和混合系统结合起来。管理员可以使用配置向导或 REST API 创建新的FlexVol卷，或者选择预先创建的FlexVol卷作为后备存储（如果有的话）。



=== 虚拟卷(Virtual Volume、Virtual Volume、Virtual Volume)

vVols是存储在vVols数据存储中的实际虚拟机文件和磁盘。使用术语 vVol（单数）指的是单个特定文件、LUN 或命名空间。ONTAP根据数据存储使用的协议创建 NVMe 命名空间、LUN 或文件。vVols)有几种不同的类型；最常见的包括配置卷 (Config，唯一使用 VMFS 文件系统的卷，包含元数据文件，例如虚拟机的 VMX 文件)、数据卷 (Data，虚拟磁盘或 VMDK) 和交换卷 (Swap，在虚拟机启动时创建)。受 VMware 虚拟机加密保护的vVols类型为“其他”。VMware VM 加密不应与ONTAP卷或聚合加密混淆。



== 基于政策的管理

VMware vSphere API for Storage Awareness (VASA) 使虚拟机管理员能够轻松使用配置虚拟机所需的任何存储功能，而无需与存储团队进行交互。在 VASA 出现之前，虚拟机管理员可以定义虚拟机存储策略，但必须与存储管理员合作来确定合适的数据存储，通常是通过文档或命名约定来实现的。借助 VASA，具有相应权限的 vCenter 管理员可以定义一系列存储功能，供 vCenter 用户用于配置虚拟机。VM 存储策略与数据存储功能之间的映射关系，使得 vCenter 能够显示可供选择的兼容数据存储列表，并支持其他技术，例如 VCF（以前称为 Aria 和 vRealize）自动化或 VMware vSphere Kubernetes 服务 (VKS)，从分配的策略中自动选择存储。这种方法被称为基于存储策略的管理。虽然 VASA Provider 规则和 VM 存储策略也可以与传统数据存储一起使用，但我们在这里的重点是vVols数据存储。



=== VM 存储策略

VM存储策略在vCenter中的策略和配置文件下创建。对于虚拟卷、请使用NetApp虚拟卷存储类型提供程序中的规则创建一个规则集。现在、与ONTAP工具9.X相比、ONTAP工具10.X提供了一种更简单的方法、它允许您直接在VM存储策略本身中指定存储属性。

如上所述、使用策略有助于简化配置VM或VMDK的任务。只需选择适当的策略、VASA Provider就会显示支持该策略的VVOs数据存储库、并将VVOV放入一个合规的FlexVol volume中。



=== 使用存储策略部署虚拟机

image::vvols-image3.png[使用存储策略部署虚拟机,800,480]

一旦虚拟机完成配置，VASA 提供商将继续检查合规性，并在备份卷不再符合策略时通过 vCenter 中的警报提醒虚拟机管理员。



=== 虚拟机存储策略合规性

image::vvols-image4.png[虚拟机存储策略合规性,320,100]



== NetApp虚拟卷支持

ONTAP自 2012 年首次发布以来就一直支持 VASA 规范。虽然其他NetApp存储系统可能支持 VASA，但本文档重点介绍当前支持的ONTAP 9 版本。



=== ONTAP

除了AFF、 ASA和FAS系统上的ONTAP 9 之外， NetApp还支持ONTAP Select上的 VMware 工作负载、带有 VMware Cloud on AWS 的Amazon FSx for NetApp 、带有 Azure VMware Solution 的Azure NetApp Files 、带有 Google Cloud VMware Engine 的Google Cloud NetApp Volumes以及 Equinix 中的NetApp Private Storage，但具体功能可能因服务提供商和可用的网络连接而异。

截至本文发布时，超大规模环境仅限于传统的 NFS v3 数据存储；因此， vVols仅适用于本地ONTAP系统，或提供本地系统全部功能的云连接系统，例如NetApp合作伙伴和全球服务提供商托管的系统。

_有关ONTAP 的详细信息，请参见 https://docs.netapp.com/us-en/ontap-family/["ONTAP 产品文档"^]_

_有关ONTAP 和VMware vSphere最佳实践的详细信息、请参见 link:vmware-vsphere-overview.html["TR-4597"^]_



== 将ONTAP与虚拟卷结合使用的优势

2015 年，VMware 在 VASA 2.0 中引入了vVols支持，他们将其描述为“一个集成和管理框架，为外部存储（SAN/NAS）提供了一种新的操作模式”。这种运行模式与ONTAP存储相结合，具有诸多优势。



=== 基于政策的管理

如第 1.2 节所述，基于策略的管理允许使用预定义的策略来配置和随后管理虚拟机。这可以从多个方面帮助IT运维：

* 提高速度。ONTAP工具消除了 vCenter 管理员为存储配置活动向存储团队开具工单的需要。但是，通过限制对特定功能的访问， ONTAP工具在 vCenter 和ONTAP系统中的 RBAC 角色仍然允许独立团队（例如存储团队）或同一团队开展独立活动。
* *更智能的配置。*存储系统功能可通过VASAAPI公开、使配置工作流可以利用高级功能、而虚拟机管理员无需了解如何管理存储系统。
* *配置速度更快。*单个数据存储库可支持不同的存储功能、并根据虚拟机策略自动为虚拟机选择相应的存储功能。
* *避免出错。*存储和VM策略是提前制定的、并根据需要应用、而无需在每次配置VM时自定义存储。如果存储功能偏离定义的策略、则会发出合规警报。如前文所述、通过使用SCP、初始配置可预测且可重复、而根据SCP制定VM存储策略可确保准确放置。
* *更好的容量管理*通过使用VASA和ONTAP工具、可以根据需要查看存储容量、使其降至各个聚合级别、并在容量开始不足时提供多层警报。




=== 在现代SAN上进行VM粒度管理

使用光纤通道和 iSCSI 的 SAN 存储系统是 VMware ESX 最早支持的存储系统，但它们缺乏从存储系统管理单个 VM 文件和磁盘的功能。相反，系统会配置 LUN，然后由 VMFS 管理各个文件。这使得存储系统难以直接管理单个虚拟机的存储性能、克隆和保护。vVols 结合了vVols存储用户已经享有的存储粒度控制，以及ONTAP强大的高性能 SAN 功能。

现在，借助 vSphere 8 和ONTAP tools for VMware vSphere， vVols用于传统 SCSI 协议的那些精细控制功能，现在也可以在现代光纤通道 SAN 中使用 NVMe over Fabrics 来实现，从而在规模上获得更高的性能。借助 vSphere 8.0 更新 1，现在可以部署完整的端到端 NVMe 解决方案，使用vVols，而无需在虚拟机管理程序存储堆栈中进行任何 I/O 转换。



=== 更出色的存储卸载功能

虽然 VAAI 提供各种卸载到存储的操作，但 VASA 提供商可以解决一些问题。SAN VAAI 无法将 VMware 管理的快照卸载到存储系统。NFS VAAI 可以卸载 VM 管理的快照，但对具有存储原生快照的 VM 存在一些限制。由于vVols使用单独的 LUN、命名空间或文件作为虚拟机磁盘， ONTAP可以快速高效地克隆文件或 LUN，从而创建 VM 粒度的快照，不再需要增量文件。NFS VAAI 也不支持热（通电）Storage vMotion 迁移的卸载克隆操作。当使用 VAAI 和传统 NFS 数据存储时，必须关闭虚拟机电源才能卸载迁移任务。ONTAP工具中的 VASA 提供程序可以实现近乎即时、存储高效的热迁移和冷迁移克隆，并且还支持对vVols进行近乎即时的跨卷迁移复制。由于这些显著的存储效率优势，您或许能够充分利用vVols工作负载。 https://www.netapp.com/pdf.html?item=/media/8207-flyer-efficiency-guaranteepdf.pdf["效率担保"] 程序。同样，如果使用 VAAI 进行跨卷克隆不能满足您的要求，那么借助vVols 的复制体验改进，您很可能能够解决您的业务难题。



=== 常见的卷使用情形

除了这些优势之外、我们还会看到VVOV存储的以下常见使用情形：

* *按需配置虚拟机*
+
** 私有云或服务提供商的IaaS。
** 通过Aia (原vReise)套件、OpenStack等利用自动化和流程编排功能。


* *一流磁盘(FCD)*
+
** VMware vSphere Kubernetes Service (VKS) 持久卷。
** 通过独立的 VMDK 生命周期管理提供类似 Amazon EBS 的服务。


* *按需配置临时虚拟机*
+
** 测试/开发实验室
** 培训环境






=== 使用卷的常见优势

在充分发挥其优势时(例如在上述使用情形中)、此类卷可提供以下具体改进：

* 在ONTAP集群中，克隆可以在单个卷内或跨多个卷快速创建，这比传统的启用 VAAI 的克隆具有优势。它们还具有良好的存储效率。卷内的克隆使用ONTAP文件克隆，类似于FlexClone卷，仅存储源 vVol 文件/LUN/命名空间的更改。因此，用于生产或其他应用程序用途的长期虚拟机可以快速创建，占用空间极小，并且可以受益于虚拟机级别的保护（使用适用于 VMware vSphere 的NetApp SnapCenter插件、VMware 管理的快照或 VADP 备份）和性能管理（使用ONTAP QoS）。使用vVols进行跨卷克隆比使用 VAAI 快得多，因为使用 VASA，我们可以在复制完成之前创建克隆并允许在目标位置访问它。数据块作为后台进程复制到目标 vVol。这与ONTAP对传统 LUN 的非中断式 LUN 迁移的工作方式类似。
* 在将TKG与vSphere CSI结合使用时、Vvol是理想的存储技术、可提供由vCenter管理员管理的离散存储类和容量。
* 亚马逊 EBS 类服务可以通过 FCD 交付，因为 FCD VMDK 顾名思义是 vSphere 中的一等公民，其生命周期可以独立于它可能附加到的虚拟机进行管理。

